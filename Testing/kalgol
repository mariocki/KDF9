ADJUNCTS=${ADJUNCTS:-Adjuncts}
BINARY=${KDF9_BINARY:-Binary}
DATA=${KDF9_DATA:-Data}
SOURCE=${KIDSGROVE:-Kidsgrove}
USERCODE=${KDF9_USERCODE:-Assembly}
TEMPORARY=${ALGOL_TEMP:-Workfiles}

# Ensure we have a valid source file.
if [ x$1x = xx ]
then
   echo No program name was given.; echo
   exit 1
elif [ ! -r ${SOURCE}/$1.a60 ]
then
   echo The file ${SOURCE}/$1.a60 is absent or unreadable.; echo
   exit 1
else
   name=$1
fi

# Delete workfiles on termination.
trap "rm -f ${TEMPORARY}/chan6.pt;
      rm -f ${TEMPORARY}/error_output;
      rm -f ${TEMPORARY}/systape.txt;
      rm -f ${TEMPORARY}/kalgol_labels.txt"   \
      0 1 2 3

> settings_1.txt

# Label the Kidsgrove system MT.
cat > ${TEMPORARY}/kalgol_labels.txt <<++++
00000000        |
00000001        |
00000002        |
00000003        |
00000004        |
00000005        |
|
++++
nine_path ${BINARY}/RLT ${TEMPORARY}/kalgol_labels.txt - zw - - t

# Populate the Kidsgrove system MT.
nine_path ${ADJUNCTS}/MKSYS2 ${ADJUNCTS}/systape.txt - zw

# Convert the source code to Algol Basic Symbols.
${ADJUNCTS}/mkchan ${SOURCE}/$name.a60 ${TEMPORARY}/chan6.pt > /dev/null

> TP0
rm -f ${BINARY}/$name
rm -f ${USERCODE}/$name.k3
rm -f ${TEMPORARY}/error_output
chmod 755 TR0


# Process any compilation options.
if [ -r settings_for_kalgol.txt ]
then
   cp settings_for_kalgol.txt settings_1.txt
fi
shift
if [ x"$1"x = "xwithx" -o x"$1"x = "xWITHx" ]
then
   shift
fi
kidopt with $* ${KIDSOPTS} >> settings_1.txt

# Run the compiler.
if nine_path ${ADJUNCTS}/KAB00DH--USU ${TEMPORARY}/chan6.pt ${KIDSMODE:--} ${KIDSMISC:-w-} ll kk 2>${TEMPORARY}/error_output
then
   if [ -s ${TEMPORARY}/error_output ]
   then
      echo The compilation was abandoned.
      echo ${TEMPORARY}/error_output:
      echo ===
      more ${TEMPORARY}/error_output
      echo ===
      exit 2
   fi

   if fgrep FAIL LP0 >/dev/null  2>/dev/null
   then
      echo The compilation was abandoned.
      echo LP0:
      echo ===
      more LP0
      echo ===
      exit 2
   fi

   if fgrep FAIL TP0 >/dev/null  2>/dev/null
   then
      echo The compilation was abandoned.
      echo TP0:
      echo ===
      more TP0
      echo ===
      exit 2
   fi

fi

# Get the generated Usercode.
case $*${KIDSOPTS} in
*OPTIMISER*)
   a2b -p2t < TP0 > ${USERCODE}/$name.k3
   ;;
*)
   mtp MT0T > ${USERCODE}/$name.k3
   ;;
esac
if [ ! -s ${USERCODE}/$name.k3 ]
then
   echo The Usercode object program could not be retrieved.; echo
   exit 3
fi

# Do not neaten if peep is going to be used.
case ${KIDSGROVE_NEATEN:-y} in
y)
   neat $name ${ST:-30000} ${TL:-99999}
   ;;
*)
   ;;
esac

case ${KIDSGROVE_ASSEMBLY:-y} in
y)
   ucc $name
   if [ ! -s ${BINARY}/$name ]
   then
      echo An object program could not be assembled.; echo
      exit 4
   fi
   echo "The Usercode   is in " ${USERCODE}/$name.k3
   echo "The executable is in " ${BINARY}/$name
   echo
   ;;
*)
   ;;
esac
