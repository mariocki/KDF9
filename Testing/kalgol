ADJUNCTS=${ADJUNCTS:-Adjuncts}
BINARY=${KDF9_BINARY:-Binary}
DATA=${KDF9_DATA:-Data}
SOURCE=${KIDSGROVE:-Kidsgrove}
USERCODE=${KDF9_USERCODE:-Assembly}
TEMP=${TEMPORARY:-/var/tmp}

trap "rm -f  ${ADJUNCTS}/chan6.pt ptp.bin mt.out ${ADJUNCTS}/punch.txt ${TEMP}/error_output;
      rm -f  ${TEMP}/systape.txt ${TEMP}/kalgol_labels.txt ${TEMP}/ABS_text.txt"   \
      0 1 2 3

if [ x${KIDSMODE}x = xfx ]
then
   KIDSMODE=""
fi

if [ x$1x = xx ]
then
   echo No program name was given.; echo
   exit 1
elif [ ! -r ${SOURCE}/$1.a60 ]
then
   echo The file ${SOURCE}/$1.a60 is absent or unreadable.; echo
   exit 1
else
   name=$1
fi

> settings_1.txt

cat > ${TEMP}/kalgol_labels.txt <<++++
00000000        |
00000001        |
00000002        |
00000003        |
00000004        |
00000005        |
|
++++
nine_path ${BINARY}/RLT ${TEMP}/kalgol_labels.txt - zw - - t

cp ${ADJUNCTS}/systape.txt ${TEMP}/systape.txt
nine_path ${ADJUNCTS}/MKSYS2 ${TEMP}/systape.txt - zw

${ADJUNCTS}/mkchan ${SOURCE}/$name.a60 ${ADJUNCTS}/chan6.pt > /dev/null

> TP0
rm -f ${BINARY}/$name
rm -f ${USERCODE}/$name.k3
rm -f ${TEMP}/error_output
chmod 755 TR0

if [ -r settings_for_kalgol.txt ]
then
   cp settings_for_kalgol.txt settings_1.txt
fi

shift
if [ x"$1"x = "xwithx" -o x"$1"x = "xWITHx" ]
then
   shift
fi

kidopt with $* ${KIDSOPTS} >> settings_1.txt

if nine_path ${ADJUNCTS}/KAB00DH--USU ${ADJUNCTS}/chan6.pt ${KIDSMODE:--} ${KIDSMISC:-w-} ll kk 2>${TEMP}/error_output
then
   if [ -s ${TEMP}/error_output ]
   then
      echo The compilation was abandoned.
      echo ${TEMP}/error_output:
      echo ===
      more ${TEMP}/error_output
      echo ===
      exit 2
   fi

   if fgrep FAIL LP0 >/dev/null  2>/dev/null
   then
      echo The compilation was abandoned.
      echo LP0:
      echo ===
      more LP0
      echo ===
      exit 2
   fi

   if fgrep FAIL TP0 >/dev/null  2>/dev/null
   then
      echo The compilation was abandoned.
      echo TP0:
      echo ===
      more TP0
      echo ===
      exit 2
   fi

fi

case $*${KIDSOPTS} in
*OPTIMISER*)
   a2b -p2t < TP0 > ${USERCODE}/$name.k3
   ;;
*)
   mtp MT0T > ${USERCODE}/$name.k3
   ;;
esac
if [ ! -s ${USERCODE}/$name.k3 ]
then
   echo The Usercode object program could not be retrieved.; echo
   exit 3
fi
neat $name ${ST:-30000} ${TL:-99999}

case ${KIDSGROVE_ASSEMBLY:-y} in
y)
   ucc $name
   if [ ! -s ${BINARY}/$name ]
   then
      echo An object program could not be assembled.; echo
      exit 4
   fi
   echo "The Usercode   is in " ${USERCODE}/$name.k3
   echo "The executable is in " ${BINARY}/$name
   echo
   ;;
*)
   ;;
esac
