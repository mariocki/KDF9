USERCODE=${KDF9_USERCODE:-Assembly}
TEMPORARY=${TEMPORARY:-/var/tmp}

trap "rm -f ${TEMPORARY}/neat.commands ${TEMPORARY}/neat_tmp_0 ${TEMPORARY}/neat_tmp_1"   \
      0 1 2 3

if [ ! -r ${USERCODE}/$1.k3 ]
then echo Could not find $1.k3 in ${USERCODE}; exit 1
fi

tr  "\\r\\t" "\\n " < ${USERCODE}/$1.k3  > ${TEMPORARY}/neat_tmp_0
tr -s "\\n" < ${TEMPORARY}/neat_tmp_0 > ${TEMPORARY}/neat_tmp_1
a2b -L2A <${TEMPORARY}/neat_tmp_1 > ${TEMPORARY}/neat_tmp_0

cat >${TEMPORARY}/neat.commands <<++++
/^ +$/d
/^ +/s//   /
10,\$s/([0123456789]) +([0123456789])/\1\2/g
10,\$s/ +;/;/g
10,\$s/; +/;/g
10,\$s/= +/=/g
10,\$s/^[ ]+//g
10,\$s/;V +/;V/g
10,\$s/;Y +/;Y/g
10,\$s/;Y(.+) +/;Y\1/g
10,\$s/;J *S */;JS/g
10,\$s/;J *P */;JP/g
10,\$s/;J *S *P */;JSP/g
10,\$s/;S *H *A */;SHA/g
10,\$s/;Z *E *R *O *;/;ZERO;/g
10,\$s/;R *E *V *;/;REV;/g
10,\$s/;S *E *T */;SET/g
10,\$s/=Y([^;]+);/=Y\1;\\
/g
10,\$s/_>Z;/GEZ;/g
10,\$s/_<Z;/LEZ;/g
10,\$s/>Z;/GTZ;/g
10,\$s/<Z;/LTZ;/g
10,\$s/(V[0123456789]+ *= *[^;]+;) *(V[0123456789]+ *= *[^;]+;)/\1\\
\2/g
10,\$s/(V[0123456789]+ *= *[^;]+; *\([^\(]+\);)/\1\\
/g
++++
sed -E -f ${TEMPORARY}/neat.commands ${TEMPORARY}/neat_tmp_0 > ${TEMPORARY}/neat_tmp_1
cat >${TEMPORARY}/neat.commands <<++++
10,\$s/;EXIT/;\\
EXIT/g
10,\$s/;(J[^;]+;)/;\\
\1/
10,\$s/ +(J[^;]+;)/\\
\1/
10,\$s/;([0123456789]+;)/;\\
\1;\\
/
10,\$s/;\*([0123456789]+;)/;\\
$\1;\\
/
10,\$s/;\$([0123456789]+;)/;\\
$\1;\\
/
10,\$s/ +(\*[1234567890];)/\\
\1\\
/
10,\$s/ +(\$[1234567890];)/\\
\1\\
/
10,\$s/^ +([1234567890];)(.+)/\\
\1\\
\2/
10,\$s/(J[^;]+;)(.+)/\\
\1\\
\2/
10,\$s/^([1234567890]+;)(.)/\\
\1\\
\2/
++++
sed -E -f ${TEMPORARY}/neat.commands ${TEMPORARY}/neat_tmp_1 > ${TEMPORARY}/neat_tmp_0
cat >${TEMPORARY}/neat.commands <<++++
10,\$s/(V[^;]+;)\n +\$/\1\\
$/
10,\$s/; *\\$/;\\
$/
10,\$s/^\(/   (/
10,\$s/^J/   J/
10,\$s/^EXIT/   EXIT/
10,\$s/^ERASE;/      ERASE;/
10,\$s/^([^1234567890EJ $])/      \1/
10,\$s/;([^ ])/; \1/g
10,\$s/; *(P[0-9]+)/;\\
\\
\1/g
10,\$s/^ +P/\\
@\\
P/
10,\$s/ +FINISH;/FINISH;\\
|\\
/
++++
sed -E -f ${TEMPORARY}/neat.commands ${TEMPORARY}/neat_tmp_0 > ${TEMPORARY}/neat_tmp_1

ex ${TEMPORARY}/neat_tmp_1  <<++++
10
/|/
.+1,\$d
w! ${TEMPORARY}/neat_tmp_1
q!
++++
tr -s "\\n" < ${TEMPORARY}/neat_tmp_1 > ${TEMPORARY}/neat_tmp_0
tr "@" "\\n" < ${TEMPORARY}/neat_tmp_0 > ${USERCODE}/$1-NEAT.k3
sttl $1-NEAT $2 $3
mv ${USERCODE}/$1-NEAT.k3 ${USERCODE}/$1.k3
